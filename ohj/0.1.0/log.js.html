<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>log.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="fluent.CopyStateOperation.html">CopyStateOperation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.CopyStateOperation.html#and">and</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.CopyStateOperation.html#fromItem">fromItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.CopyStateOperation.html#toItem">toItem</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="fluent.FunctionConditionConf.html">FunctionConditionConf</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="FluentRule.html">FluentRule</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="items.OHItem.html">OHItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.OHItem.html#getMetadataValue">getMetadataValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.OHItem.html#postUpdate">postUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.OHItem.html#sendCommand">sendCommand</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.OHItem.html#sendCommandIfDifferent">sendCommandIfDifferent</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="log.Logger.html">Logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#atLevel">atLevel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#debug">debug</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#error">error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#info">info</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#trace">trace</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="log.Logger.html#warn">warn</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="actions.html">actions</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="fluent.html">fluent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.copyAndSendState">copyAndSendState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.copyState">copyState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.cron">cron</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.inGroup">inGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.item">item</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.postUpdate">postUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.send">send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.sendIt">sendIt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.sendOff">sendOff</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.sendOn">sendOn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.sendToggle">sendToggle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.stateOfItem">stateOfItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.timeOfDay">timeOfDay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.when">when</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="fluent.html#.when">when</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="items.html">items</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.html#.addItem">addItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="items.html#.removeItem">removeItem</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="log.html">log</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="osgi.html">osgi</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="osgi.html#.findServices">findServices</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="osgi.html#.getService">getService</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="rules.html">rules</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="rules.html#.JSRule">JSRule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="rules.html#.SwitchableJSRule">SwitchableJSRule</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="triggers.html">triggers</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">log.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Log namespace.
 * This namespace provides loggers to log messages to the Openhab Log.
 * 
 * @example &lt;caption>Basic logging&lt;/caption>
 * let log = require('ohj').log('my_logger');
 * log.info("Hello World!")
 * 
 * @namespace log
 */

/**
 * Logger prefix
 * @memberOf log
 */
const LOGGER_PREFIX = "script.js";

const RuntimeExceptionEx = Java.extend(Java.type('java.lang.RuntimeException'));

/**
 * Logger class. A named logger providing the ability to log formatted messages.
 * 
 * @memberof log
 * @hideconstructor
 */
class Logger {
    /**
     * Creates a new logger. Don't use directly, use {@link log} on module.
     * 
     * @param {String} _name the name of the logger. Will be prefixed by {@link LOGGER_PREFIX}
     * @param {*} _listener a callback to receive logging calls. Can be used to send calls elsewhere, such as escalate errors.
     */
    constructor(_name, _listener) {
        this._name = _name || this._getCallerDetails("", 3).fileName.replace(/\.[^/.]+$/, "")
        this._listener = _listener;
        this._logger = Java.type("org.slf4j.LoggerFactory").getLogger(LOGGER_PREFIX + "." + this.name.toString().toLowerCase());
    }

    /**
     * Method to determine caller. Don't use directly.
     * 
     * @private
     * @param {Object} msg the message to get caller details for
     * @param {Number} ignoreStackDepth the number of stack frames which to ignore in calculating caller
     * @returns {Error} message as an error object, with fileName, caller and optional lineNumber properties
     */
    _getCallerDetails(msg, ignoreStackDepth) {
        let stackLine = null;

        if (!(msg instanceof Error)) {
            msg = Error(msg);
            stackLine = msg.stack.split('\n')[ignoreStackDepth];
        } else {
            stackLine = msg.stack.split('\n')[1];
        }

        //pick out the call, fileName &amp; lineNumber from the specific frame
        let match = stackLine.match(/^\s+at\s*(?&lt;caller>[^ ]*) \(?(?&lt;fileName>[^:]+):(?&lt;lineNumber>[0-9]+):[0-9]+\)?/);

        if (match) {
            Object.assign(msg, match.groups);
        } else { //won't match an 'eval'd string, so retry
            match = stackLine.match(/\s+at\s+\&lt;eval\>:(?&lt;lineNumber>[0-9]+):[0-9]+/)
            if (match) {
                Object.assign(msg, {
                    fileName: "&lt;unknown>",
                    caller: "&lt;root script>"
                }, match.groups)
            } else throw Error(`Failed to parse stack line: ${stackLine}`);
        }

        return msg;
    }

    /**
     * Method to format a log message. Don't use directly.
     * 
     * @private
     * @param {Object} msg the message to get caller details for
     * @param {String} levelString the level being logged at
     * @param {Number} ignoreStackDepth the number of stack frames which to ignore in calculating caller
     * @param {String} [prefix=log] the prefix type, such as none, level, short or log.
     * @returns {Error} message with 'message' String property
     */
    _formatLogMessage(msg, levelString, ignoreStackDepth, prefix = "log") {

        let clazz = this;
        let msgData = {
            message: msg.toString(),
            get caller() {//don't run this unless we need to, then cache it
                this.cached = this.cached || clazz._getCallerDetails(msg, ignoreStackDepth)
                return this.cached;
            }
        };

        levelString = levelString.toUpperCase();

        switch (prefix) {
            case "none": return msgData.message;
            case "level": return `[${levelString}] ${msgData.message}`
            case "short": return `${msgData.message}\t\t[${this.name}, ${msgData.caller.fileName}:${msgData.caller.lineNumber}]`
            case "log": return `${msgData.message}\t\t[${this.name} at source ${msgData.caller.fileName}, line ${msgData.caller.lineNumber}]`
            default: throw Error(`Unknown prefix type ${prefix}`)
        }
    }

    /**
     * Logs at ERROR level.
     * @see atLevel
     */
    error() { this.atLevel('error', ...arguments) }
    /**
     * Logs at ERROR level.
     * @see atLevel
     */
    warn() { this.atLevel('warn', ...arguments) }
    /**
     * Logs at INFO level.
     * @see atLevel
     */
    info() { this.atLevel('info', ...arguments) }
    /**
     * Logs at DEBUG level.
     * @see atLevel
     */
    debug() { this.atLevel('debug', ...arguments) }
    /**
     * Logs at TRACE level.
     * @see atLevel
     */
    trace() { this.atLevel('trace', ...arguments) }

    /**
     * Logs a message at the supplied level. The message may include placeholders {} which
     * will be substituted into the message string only if the message is actually logged.
     * 
     * @example
     * log.atLevel('INFO', 'The widget was created as {}', widget);
     * 
     * 
     * @param {String} level The level at which to log, such as 'INFO', or 'DEBUG'
     * @param {String|Error} msg the message to log, possibly with object placeholders
     * @param {Object[]} [objects] the objects to substitute into the log message
     */
    atLevel(level, msg, ...objects) {
        let titleCase = level[0].toUpperCase() + level.slice(1)
        try {
            if (this._logger[`is${titleCase}Enabled`]()) {

                this.maybeLogWithThrowable(level, msg, objects) ||
                    this._logger[level](this._formatLogMessage(msg, level, 6), objects);

                if (this._listener) {
                    this._listener(msg, level, objects)
                }
            }
        } catch (err) {
            this._logger.error(this._formatLogMessage(err, "error", 0));
        }
    }

    maybeLogWithThrowable(level, msg, objects) {
        if(objects.length === 1){
            let obj = objects[0];
            if((obj instanceof Error || (obj.message &amp;&amp; obj.name &amp;&amp; obj.stack)) &amp;&amp; !msg.includes("{}")) { //todo: better substitution detected
                //log the basic message
                this._logger[level](msg);

                //and log the exception
                this._logger[level](`${obj.name} : ${obj.message}\n${obj.stack}`);
                return true;
            }
        }
        return false;
    }

    /**
     * The listener function attached to this logger.
     * @return {*} the listener function
     */
    get listener() { return this._listener }

    /**
     * The name of this logger
     * @return {String} the logger name
     */
    get name() { return this._name }
}

/**
 * Creates a logger.
 * @see Logger
 * @name default
 * @param {string} name the name of the logger
 * @param {*} [_listener] an optional listener to process log events.
 * @memberof log
 */
module.exports = function (_name, _listener) {
    return new Logger(_name, _listener);
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sat Nov 30 2019 01:47:35 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
